# name: Publish Krista Infinispan package

# on:
#   push:
#     tags:
#       - 'v-infinispan-*'  # Changed to expect version suffix
#   workflow_dispatch:

# jobs:

#   publish:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       packages: write

#     steps:
#     - uses: actions/checkout@v4
    
#     - name: Extract version from tag
#       id: version
#       run: |
#         # Extract version from tag (e.g., v-infinispan-1.2.3 -> 1.2.3)
#         VERSION=${GITHUB_REF#refs/tags/v-infinispan-}
#         echo "version=$VERSION" >> $GITHUB_OUTPUT
#         echo "Extracted version: $VERSION"

#         # Validate version format
#         if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
#           echo "ERROR: Invalid version format: $VERSION"
#           echo "Expected format: x.y.z (e.g., 1.0.1)"
#           exit 1
#         fi

#     - name: Check if version exists on PyPI
#       run: |
#         VERSION="${{ steps.version.outputs.version }}"
#         if pip index versions krista-infinispan | grep -q "$VERSION"; then
#           echo "ERROR: Version $VERSION already exists on PyPI"
#           echo "Please use a different version number"
#           exit 1
#         fi
#         echo "Version $VERSION is available"
    
#     - name: Set up Python
#       uses: actions/setup-python@v4
#       with:
#         python-version: '3.9'
    
#     - name: Install build tools
#       run: |
#         python -m pip install --upgrade pip
#         pip install build twine
    
#     - name: Build package
#       run: |
#         cd krista_infinispan
#         VERSION="${{ steps.version.outputs.version }}"
        
#         # Replace version in pyproject.toml before building
#         sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
        
#         # Build with the updated version
#         python -m build
        
#         # Show what was built
#         ls -la dist/
#         echo "Built packages:"
#         ls dist/
    
#     - name: Publish to PyPI
#       env:
#         TWINE_USERNAME: __token__
#         TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
#       run: |
#         cd krista_infinispan
#         python -m twine upload dist/*
